<!doctype html>
<html
  xmlns:th="http://www.thymeleaf.org"
  xmlns:layout="http://www.ultraq.net.nz/thymeleaf/layout"
  layout:decorate="~{layouts/mypagelayout}"
>
  <head>
    <meta charset="UTF-8" />
    <title>알림</title>
    <th:block layout:fragment="script">
      <script th:inline="javascript">
        // API URL 설정
        const NOTIFICATION_API_URL = "/notifications";

        // 알림 목록 불러오기 함수
        function loadNotifications() {
          const userId = /*[[${#authentication.principal.id}]]*/ "anonymous"; // 로그인한 사용자의 ID
          console.log("사용자 ID의 알림 로딩 중:", userId); // 디버깅 로그 추가

          $.ajax({
            type: "GET",
            url: `${NOTIFICATION_API_URL}?userId=${userId}`,
            success: function (notifications) {
              console.log("알림 가져옴:", notifications); // 디버깅 로그 추가

              const notificationList = $("#notification-list");
              const notificationListPop = $("#notification-list-pop");
              const unreadCountElement = $("#unread-count");
              const unreadCountBadge = $("#noti-count");

              notificationList.empty();
              notificationListPop.empty();

              let unreadCount = 0;

              notifications.forEach((notification) => {
                const readStatus = notification.read ? "읽음" : "읽지 않음";
                const notificationClass = notification.read
                  ? "read-notification"
                  : "";
                if (!notification.read) {
                  unreadCount++;
                }
                notificationList.append(
                  `
					<li class="${notificationClass}">
					<a href="board/view?id=${notification.board.id}" onclick="markAsRead(${notification.id})">
					${notification.message}</a>
					<button onclick="markAsReadToggle(${notification.id})">읽음 표시</button>
					<i class="far fa-trash-alt delete-icon fa-lg btn-icon delete-noti" onclick="deleteNoti(${notification.id})"></i>
					</li>`,
                );
                notificationListPop.append(
                  `
					<li class="${notificationClass}">
					<a href="board/view?id=${notification.board.id}" onclick="markAsRead(${notification.id})">
					${notification.message}</a>
					<button onclick="markAsReadToggle(${notification.id})">읽음 표시</button>
					<i class="far fa-trash-alt delete-icon fa-lg btn-icon delete-noti" onclick="deleteNoti(${notification.id})"></i>
					</li>`,
                );
              });
              // 안 읽은 알림 개수 업데이트
              if (unreadCount === 0) {
                unreadCountElement.text("모든 알림을 읽었습니다");
                unreadCountBadge.hide();
              } else {
                unreadCountElement.text(`안 읽은 알림: ${unreadCount}`);
                unreadCountBadge.text(unreadCount);
                unreadCountBadge.show();
              }
            },
            error: function (error) {
              console.error("알림 목록 불러오기 중 오류 발생:", error);
            },
          });
        }

        // 알림 읽음 표시 함수
        function markAsRead(id) {
          $.ajax({
            type: "POST",
            url: `${NOTIFICATION_API_URL}/${id}/read`,
            success: function () {
              loadNotifications();
            },
            error: function (error) {
              console.error("알림 읽음 표시 중 오류 발생:", error);
            },
          });
        }
        function markAsReadToggle(id) {
          $.ajax({
            type: "POST",
            url: `${NOTIFICATION_API_URL}/${id}/readtoggle`,
            success: function () {
              loadNotifications();
            },
            error: function (error) {
              console.error("알림 읽음 표시 중 오류 발생:", error);
            },
          });
        }
        function deleteNoti(id) {
          $.ajax({
            type: "DELETE",
            url: `${NOTIFICATION_API_URL}/${id}/delete`,
            success: function () {
              loadNotifications();
            },
            error: function (error) {
              console.error("알림 삭제 중 오류 발생:", error);
            },
          });
        }

        // 페이지 로드 시 데이터 불러오기
        $(document).ready(function () {
          loadNotifications();
        });
      </script>
    </th:block>
    <style>
      .read-notification > a {
        color: gray;
      }
      .delete-noti {
        cursor: pointer;
      }
    </style>
  </head>
  <body>
    <div layout:fragment="content">
      <section id="notifications-section">
        <h2>알림 목록</h2>
        <div id="unread-count"></div>
        <ul id="notification-list"></ul>
      </section>
    </div>
  </body>
</html>
